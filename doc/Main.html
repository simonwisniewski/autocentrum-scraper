<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class Main - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
  var index_rel_prefix = "./";
</script>

<script src="./js/navigation.js" defer></script>
<script src="./js/search.js" defer></script>
<script src="./js/search_index.js" defer></script>
<script src="./js/searcher.js" defer></script>
<script src="./js/darkfish.js" defer></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">


<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search (/) for a class, method, ..." spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
<div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  <p class="link">Object
</div>

    
    
    
<!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    <li ><a href="#method-c-new">::new</a>
    <li ><a href="#method-i-add_car">#add_car</a>
    <li ><a href="#method-i-car_already_loaded-3F">#car_already_loaded?</a>
    <li ><a href="#method-i-check_and_load_existing_report">#check_and_load_existing_report</a>
    <li ><a href="#method-i-fetch_and_parse_sitemap">#fetch_and_parse_sitemap</a>
    <li ><a href="#method-i-generate_report">#generate_report</a>
    <li ><a href="#method-i-process_link">#process_link</a>
    <li ><a href="#method-i-scrap">#scrap</a>
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Main">
  <h1 id="class-Main" class="class">
    class Main
  </h1>

  <section class="description">
    
<p>The <a href="Main.html"><code>Main</code></a> class orchestrates the scraping process. It fetches URLs from a sitemap, processes each link to gather car data, and generates a report.</p>

  </section>

  <section id="5Buntitled-5D" class="documentation-section">





     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

      <div id="method-c-new" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">new</span><span
              class="method-args">()</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          <p>Initializes a new <a href="Main.html"><code>Main</code></a> object.</p>

<p>Sets up the initial state, including loading existing report data if available, fetching and parsing the sitemap, and starting the scraping process.</p>

          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File main.rb, line 23</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>
  <span class="ruby-ivar">@cars</span> = []
  <span class="ruby-ivar">@report_file</span> = <span class="ruby-string">&#39;./reports/report.csv&#39;</span>
  <span class="ruby-ivar">@car_urls</span> = <span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-ivar">@car_counter</span> = <span class="ruby-value">0</span>
  <span class="ruby-ivar">@logger</span> = <span class="ruby-constant">Logger</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;main.log&#39;</span>, <span class="ruby-value">1_024_000</span>)

  <span class="ruby-identifier">check_and_load_existing_report</span>
  <span class="ruby-identifier">fetch_and_parse_sitemap</span>
  <span class="ruby-identifier">scrap</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

    </section>

     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

      <div id="method-i-add_car" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">add_car</span><span
              class="method-args">(version_or_engine_data)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          <p>Adds a carâ€™s data by scraping the given URL.</p>

<p>It scrapes the data, creates a <a href="Car.html"><code>Car</code></a> object, and adds it to the list of cars. If an error occurs, it logs the error.</p>

<p>@param [String] version_or_engine_data The URL to scrape.</p>

          <div class="method-source-code" id="add_car-source">
            <pre><span class="ruby-comment"># File main.rb, line 126</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">add_car</span>(<span class="ruby-identifier">version_or_engine_data</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">car_already_loaded?</span>(<span class="ruby-identifier">version_or_engine_data</span>)

  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">scraper</span> = <span class="ruby-constant">Scraper</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">version_or_engine_data</span>)
    <span class="ruby-identifier">version_details</span> = <span class="ruby-identifier">scraper</span>.<span class="ruby-identifier">scrap</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">version_details</span>.<span class="ruby-identifier">nil?</span>

    <span class="ruby-identifier">car</span> = <span class="ruby-constant">Car</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">version_details</span>)
    <span class="ruby-ivar">@car_counter</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-ivar">@cars</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">car</span>)
    <span class="ruby-ivar">@car_urls</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">version_or_engine_data</span>)
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;[\e[32m##{@car_counter}\e[0m]&quot;</span>
    <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;[#{@car_counter}] Added car: #{version_or_engine_data}&quot;</span>)
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">StandardError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">error</span>(<span class="ruby-node">&quot;Error adding car: #{e.message}&quot;</span>)
    <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">error</span>(<span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>))
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-car_already_loaded-3F" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">car_already_loaded?</span><span
              class="method-args">(link)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          <p>Checks if the car data for a given link is already loaded.</p>

<p>@param [String] link The URL to check. @return [Boolean] True if the car data is already loaded, false otherwise.</p>

          <div class="method-source-code" id="car_already_loaded-3F-source">
            <pre><span class="ruby-comment"># File main.rb, line 115</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">car_already_loaded?</span>(<span class="ruby-identifier">link</span>)
  <span class="ruby-ivar">@car_urls</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">link</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-check_and_load_existing_report" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">check_and_load_existing_report</span><span
              class="method-args">()</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          <p>Checks for an existing report file and loads the car data if it exists.</p>

<p>If the report file is found, it loads the cars and their URLs into memory. If the report file is not found, it starts from scratch.</p>

          <div class="method-source-code" id="check_and_load_existing_report-source">
            <pre><span class="ruby-comment"># File main.rb, line 40</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">check_and_load_existing_report</span>
  <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-ivar">@report_file</span>)
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Loading existing report from #{@report_file}...&quot;</span>
    <span class="ruby-ivar">@cars</span> = <span class="ruby-constant">ReportGenerator</span>.<span class="ruby-identifier">read_cars_from_file</span>(<span class="ruby-ivar">@report_file</span>)
    <span class="ruby-ivar">@car_urls</span> = <span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@cars</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:print_url</span>))
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Report file #{@report_file} not found. Starting from scratch...&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-fetch_and_parse_sitemap" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">fetch_and_parse_sitemap</span><span
              class="method-args">()</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          <p>Fetches and parses the sitemap to extract all car-related URLs.</p>

<p>It fetches the sitemap from the given URL, removes namespaces for easier processing, and filters out URLs that do not lead to specific car data.</p>

          <div class="method-source-code" id="fetch_and_parse_sitemap-source">
            <pre><span class="ruby-comment"># File main.rb, line 55</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">fetch_and_parse_sitemap</span>
  <span class="ruby-identifier">sitemap_url</span> = <span class="ruby-string">&#39;https://www.autocentrum.pl/sitemap/daneTechniczne.xml&#39;</span>
  <span class="ruby-identifier">response</span> = <span class="ruby-constant">HttpartyHandler</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">sitemap_url</span>)

  <span class="ruby-identifier">sitemap</span> = <span class="ruby-constant">Nokogiri</span><span class="ruby-operator">::</span><span class="ruby-constant">XML</span>(<span class="ruby-identifier">response</span>)
  <span class="ruby-identifier">sitemap</span>.<span class="ruby-identifier">remove_namespaces!</span>

  <span class="ruby-identifier">all_links</span> = <span class="ruby-identifier">sitemap</span>.<span class="ruby-identifier">xpath</span>(<span class="ruby-string">&#39;//url/loc&#39;</span>).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:text</span>)
  <span class="ruby-ivar">@sitemap_links</span> = <span class="ruby-identifier">all_links</span>.<span class="ruby-identifier">reject</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">link</span><span class="ruby-operator">|</span> <span class="ruby-identifier">link</span>.<span class="ruby-identifier">count</span>(<span class="ruby-string">&#39;/&#39;</span>) <span class="ruby-operator">&lt;=</span> <span class="ruby-value">5</span> }
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-generate_report" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">generate_report</span><span
              class="method-args">()</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          <p>Generates a report with the collected car data.</p>

<p>If no cars have been collected, it prints a message indicating that no report will be generated.</p>

          <div class="method-source-code" id="generate_report-source">
            <pre><span class="ruby-comment"># File main.rb, line 150</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">generate_report</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@cars</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@cars</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&#39;No cars to generate report.&#39;</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">report_generator</span> = <span class="ruby-constant">ReportGenerator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&#39;./reports/report.csv&#39;</span>)
  <span class="ruby-identifier">report_generator</span>.<span class="ruby-identifier">generate_report</span>(<span class="ruby-ivar">@cars</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-process_link" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">process_link</span><span
              class="method-args">(link)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          <p>Processes a single link by checking if the car data is already loaded.</p>

<p>If the car data is not already loaded, it adds the car.</p>

<p>@param [String] link The URL to process.</p>

          <div class="method-source-code" id="process_link-source">
            <pre><span class="ruby-comment"># File main.rb, line 104</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">process_link</span>(<span class="ruby-identifier">link</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">car_already_loaded?</span>(<span class="ruby-identifier">link</span>)

  <span class="ruby-identifier">add_car</span>(<span class="ruby-identifier">link</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-scrap" class="method-detail ">
        <div class="method-header">
          <div class="method-heading">
            <span class="method-name">scrap</span><span
              class="method-args">()</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
        </div>

        <div class="method-description">
          <p>Starts the scraping process by processing each link from the sitemap.</p>

<p>It uses a thread pool to handle multiple links concurrently and ensures all threads are completed before finishing. If interrupted or an error occurs, it logs the error and generates the report with the data collected so far.</p>

          <div class="method-source-code" id="scrap-source">
            <pre><span class="ruby-comment"># File main.rb, line 72</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">scrap</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-string">&#39;Scraping started...&#39;</span>

  <span class="ruby-identifier">thread_pool</span> = <span class="ruby-constant">Concurrent</span><span class="ruby-operator">::</span><span class="ruby-constant">FixedThreadPool</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">200</span>) <span class="ruby-comment"># Limit based on your system resources</span>

  <span class="ruby-ivar">@sitemap_links</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">link</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">thread_pool</span>.<span class="ruby-identifier">post</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">process_link</span>(<span class="ruby-identifier">link</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">thread_pool</span>.<span class="ruby-identifier">shutdown</span>
  <span class="ruby-identifier">thread_pool</span>.<span class="ruby-identifier">wait_for_termination</span>

  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Scraping finished. Scraped #{@cars.count} cars.&quot;</span>
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">Interrupt</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;Operation was interrupted by the user. Scraped #{@cars.count} cars.&quot;</span>
  <span class="ruby-identifier">exit</span>
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">StandardError</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
  <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;An error occurred: #{e.message}&quot;</span>
  <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">error</span>(<span class="ruby-node">&quot;Error during scraping: #{e.message}&quot;</span>)
  <span class="ruby-ivar">@logger</span>.<span class="ruby-identifier">error</span>(<span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>))
<span class="ruby-keyword">ensure</span>
  <span class="ruby-identifier">generate_report</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

    </section>

  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.6.3.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

